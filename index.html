<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Test Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const App = () => {
            const [sessionId, setSessionId] = React.useState('');
            const [serverUrl, setServerUrl] = React.useState('');
            const [selectedFile, setSelectedFile] = React.useState(null);
            const [fetchError, setFetchError] = React.useState('');
            const [currentData, setCurrentData] = React.useState([]);
            const [outputMessage, setOutputMessage] = React.useState('');
            const [coordinates, setCoordinates] = React.useState({ x: 0, y: 0 });

            // Generate a random session ID on component load
            React.useEffect(() => {
                setSessionId(Math.random().toString(36).substring(2));
            }, []);

            // Handle server URL input
            const handleServerUrlChange = (e) => {
                setServerUrl(e.target.value);
            };

            // Handle file input change
            const handleFileChange = (event) => {
                setSelectedFile(event.target.files[0]);
            };

            // Upload a file to the server
            const handleFileUpload = async () => {
                if (!selectedFile) {
                    setOutputMessage('Please select a file before uploading.');
                    return;
                }

                const formData = new FormData();
                formData.append('image', selectedFile);
                formData.append('sessionID', sessionId);

                try {
                    const response = await fetch(`${serverUrl}/upload`, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                        throw new Error(`Server returned error: ${response.status}`);
                    }

                    const data = await response.json();
                    setOutputMessage(JSON.stringify(data, null, 2));
                } catch (error) {
                    setOutputMessage(`Error uploading file: ${error.message}`);
                }
            };

            // Handle coordinate input changes
            const handleCoordinateChange = (e, coord) => {
                setCoordinates((prev) => ({
                    ...prev,
                    [coord]: parseInt(e.target.value) || 0,
                }));
            };

            // Send coordinates to the server
            const handleSendCoordinates = async () => {
                try {
                    const response = await fetch(`${serverUrl}/sendback`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sessionID: sessionId,
                            x: coordinates.x,
                            y: coordinates.y,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error(`Server returned error: ${response.status}`);
                    }

                    const data = await response.json();
                    setOutputMessage(JSON.stringify(data, null, 2));
                } catch (error) {
                    setOutputMessage(`Error sending coordinates: ${error.message}`);
                }
            };

            // Fetch data from the server
            const handleFetchData = async () => {
                if (!serverUrl) {
                    setFetchError('Please specify a valid server URL.');
                    return;
                }

                try {
                    const response = await fetch(`${serverUrl}/getdata`);
                    const rawText = await response.text();
                    console.log('Server Response:', rawText);

                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }

                    const data = JSON.parse(rawText); // Parse JSON data
                    setCurrentData(data);
                    setFetchError('');
                } catch (error) {
                    setFetchError(`Error retrieving data: ${error.message}`);
                    console.error('Fetch error:', error.message);
                }
            };

            return (
                <div className="p-6 max-w-4xl mx-auto space-y-6">
                    {/* Server URL Input */}
                    <div className="bg-white shadow rounded-lg p-6">
                        <h2 className="text-lg font-semibold mb-4">Server Configuration</h2>
                        <input
                            type="text"
                            placeholder="Enter server URL (e.g., http://localhost:5999)"
                            value={serverUrl}
                            onChange={handleServerUrlChange}
                            className="w-full p-2 border rounded"
                        />
                    </div>

                    {/* Session Info */}
                    <div className="bg-white shadow rounded-lg p-6">
                        <h2 className="text-lg font-semibold mb-4">Session Information</h2>
                        <p>Session ID: <span className="font-mono text-blue-600">{sessionId}</span></p>
                    </div>

                    {/* File Upload */}
                    <div className="bg-white shadow rounded-lg p-6">
                        <h2 className="text-lg font-semibold mb-4">File Upload Test</h2>
                        <input
                            type="file"
                            onChange={handleFileChange}
                            accept="image/*"
                            className="mb-4"
                        />
                        <button
                            onClick={handleFileUpload}
                            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                        >
                            Upload File
                        </button>
                    </div>

                    {/* Coordinate Test */}
                    <div className="bg-white shadow rounded-lg p-6">
                        <h2 className="text-lg font-semibold mb-4">Coordinate Test</h2>
                        <div className="flex gap-4 mb-4">
                            <input
                                type="number"
                                placeholder="X coordinate"
                                value={coordinates.x}
                                onChange={(e) => handleCoordinateChange(e, 'x')}
                                className="p-2 border rounded"
                            />
                            <input
                                type="number"
                                placeholder="Y coordinate"
                                value={coordinates.y}
                                onChange={(e) => handleCoordinateChange(e, 'y')}
                                className="p-2 border rounded"
                            />
                        </div>
                        <button
                            onClick={handleSendCoordinates}
                            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                        >
                            Send Coordinates
                        </button>
                    </div>

                    {/* Data Retrieval */}
                    <div className="bg-white shadow rounded-lg p-6">
                        <h2 className="text-lg font-semibold mb-4">Data Retrieval Test</h2>
                        <button
                            onClick={handleFetchData}
                            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-4"
                        >
                            Fetch Data
                        </button>
                        {fetchError && (
                            <div className="text-red-500 mb-4">
                                {fetchError}
                            </div>
                        )}
                        <div className="overflow-x-auto">
                            {currentData.length > 0 ? (
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Session ID</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">X</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Y</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {currentData.map((row, index) => (
                                            <tr key={index}>
                                                <td className="px-6 py-4 whitespace-nowrap">{row.session_id}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">{row.x}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">{row.y}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">{row.timestamp}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            ) : (
                                <p>No data available. Try fetching again.</p>
                            )}
                        </div>
                    </div>

                    {/* Results */}
                    <div className="bg-white shadow rounded-lg p-6">
                        <h2 className="text-lg font-semibold mb-4">Results</h2>
                        <pre className="bg-gray-100 p-4 rounded overflow-x-auto">
                            {outputMessage}
                        </pre>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>